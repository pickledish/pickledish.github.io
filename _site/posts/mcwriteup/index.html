<!DOCTYPE html>
<html>

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MC Time Series Subset Search — willett dot io</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,600">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

	<style>
		body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
}

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url("../../images/modules/styleguide/para.png") no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  border: 0 none;
  color: #cccccc;
  height: 2px;
  padding: 0; }

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }

ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

ul :last-child, ol :last-child {
  margin-bottom: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }
		body {
	font-family: "Source Sans Pro", Helvetica, Arial, sans-serif;
}

.section {
	padding-top: 0px;
}

.footer {
	padding-top: 0rem;
	background-color: white;
	padding-bottom: 1.5rem;
	line-height: 1.5;
	color: #999999;
}

/* Makes the footer stick to the bottom of the page */
.Site {
	display: flex;
	min-height: 100vh;
	flex-direction: column;
}
.Site-content {
	flex: 1;
}

/* Fixes footer spacing */
.Site-content > section {
	padding-bottom: 1.5rem;
}

/* Spacing for the list in post-list */
.ul_posts {
	list-style: none;
	padding-left: 0;
}

.li_posts {
	list-style: none;
	margin-bottom: 2rem;
}

.li_posts > h3 {
	margin-bottom: 0;
}

/* The rest! */

.light {
	font-weight: 300; }

body {
	font-size: 12pt; 
	color: #3a3a3a;  }

code, pre {
	font-family: "Roboto Mono", "Consolas", monospace;
	font-size: 10pt;
}

a {
	color: #ba8c2a;
}

li {
	list-style: initial;
}

h1 {
  font-weight: 600;
  font-size: 48px;
  margin: 0; }

h2 {
  font-weight: 600;
  font-size: 32px;
  border-bottom: 1px solid #cccccc; }

h3 {
  font-weight: 600;
  font-size: 24px; }

h4 {
  font-weight: 600;
  font-size: 18px; }

h5 {
  font-weight: 600;
  font-size: 14px; }

h6 {
  font-weight: 600;
  color: #777777;
  font-size: 14px; }


		.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */

	</style>

	<script>
		MathJax.Hub.Config({ tex2jax: {
			inlineMath: [['$','$'], ['\\(','\\)']],
			processEscapes: true
		} });
	</script>

</head>

<body class="Site">

	<main class="Site-content">

		<section class="hero is-white">

			<!-- Hero header: will be at the top of the hero -->
			<div class="hero-head">
				<nav class="navbar"><div class="container">

					<div class="navbar-brand">
						<span class="navbar-item"><span class="is-size-4">brandon willett</span></span>
						<span class="navbar-burger burger" onclick="document.querySelector('.navbar-menu').classList.toggle('is-active');">
							<span></span>
							<span></span>
							<span></span>
						</span>
					</div>

					<div id="navbarMenuHeroA" class="navbar-menu">
						<div class="navbar-end">
							<a href="/" class="navbar-item">Home</a>
							<a href="/about/" class="navbar-item">About</a>
							<a href="/contact/" class="navbar-item">Contact</a>
							<a href="https://github.com/pickledish" class="navbar-item">
								<span class="icon"><i class="fa fa-github fa-lg"></i></span>
							</a>
						</div>
					</div>

				</div></nav>
			</div>

			<!-- Hero content: will be in the middle -->
			<div class="hero-body">
				<div class="container has-text-centered">
					<h1 class="light">
						MC Time Series Subset Search
					</h1>
				</div>
			</div>

		</section>

		<section class="section">

			<div class="columns is-centered">
				<div class="column is-half">
					<h2 id="the-goal">The Goal</h2>

<p>The goal of the program is to take in a set of time-series data, in our current case stock closing prices for $n$ different stocks, and use a Monte Carlo analysis to determine the “best” subset of those $n$ stocks. In our case, “best” is defined to be the subset that yields a high return (during the analyzed time period of course, but hopefully holding for the future as well) while minimizing risk.</p>

<h2 id="what-we-currently-do">What We Currently Do</h2>

<h3 id="the-setup">The Setup</h3>

<p>On the left of the screen, there are several input fields:</p>

<ul>
  <li><code class="highlighter-rouge">Iterations</code>, which is an integer representing how thoroughly the algorithm investigates “best” subset possibilities</li>
  <li><code class="highlighter-rouge">Anneal</code>, which is a real number used to determine how often “bad” states are accepted despite their “bad”-ness</li>
  <li><code class="highlighter-rouge">Risk Free</code>, a real number in $[0,1]$ which adjusts the “return” vector to more accurately reflect real-life earnings</li>
  <li><code class="highlighter-rouge">Stock Codes</code>, a comma-separated list of U.S. ticker names to fetch time-series price data of</li>
  <li><code class="highlighter-rouge">Start</code> and <code class="highlighter-rouge">End</code>, the date range in which to fetch data for the aforementioned ticker names</li>
  <li><code class="highlighter-rouge">Sample</code>, the frequency at which to sample the closing prices (every day, every month, every year, and so on)</li>
</ul>

<p>Upon clicking “Submit”, we use the Quandl API to fetch up-to-date closing prices of the tickers based on <code class="highlighter-rouge">Stock Codes</code> across the given date range <code class="highlighter-rouge">Start</code> to <code class="highlighter-rouge">End</code>. Then, we arrange the data into a matrix $T$, with row-vectors being the data from a single stock, thus getting an $n \times m$ matrix where $m$ is the number of samples based on <code class="highlighter-rouge">Sample</code>. From $T$, we create two new matrices:</p>

<ol>
  <li>$C$, the correlation matrix, which is of dimension $n \times n$ and where entry $C_{ij}$ represents the correlation of the time-series row vectors of stock $i$ and stock $j$</li>
  <li>$D$, a special matrix also of dimension $n \times n$, where $D$ is created using the covariance matrix through a process detailed below.</li>
</ol>

<blockquote>
  <p>Note: $C$ and $D$ are made deliberately so that they act in roughly the same way with respect to the algorithm, and either one can be dropped in to act as the driving matrix of the algorithm. We’ll just use $C$ below for simplicity.</p>
</blockquote>

<p>Using our time-series matrix $T$, we also find $b$, the “average return” vector. Each of the $n$ components of $b$ is calculated as follows:</p>

<script type="math/tex; mode=display">b_i = n \cdot \left(\frac{T_{in}}{T_{i1}}\right)^{1\,/\,(n - 1)}</script>

<p>Thus, equipped with an $n \times n$ matrix $C$ and a size-$n$ vector $b$, we can solve the equation $Cx = b$ to find the solution vector $x$, and then normalize $x$ to get $x’$. We then define the tuple $(C, x’, b)$ to be a “state” of our algorithm, and we can rephrase the Goal at the top as follows: we’re trying to find the state with the highest score, where the score of a state is defined to be:</p>

<script type="math/tex; mode=display">s(C, x', b) = \frac{
	\sum_{i=1}^n{b_i x_i'}
}{
	\sum_{i=1}^n{C_{ii}^2x_i'} + 
	\sum_{i=1}^n \sum_{j \neq i}{C_{ij} x_i' x_j'}
}</script>

<h3 id="finding-d">Finding $D$</h3>

<p>Using the correlation matrix $C$ gives good results, but is not an ideal solution, since the main diagonal of $C$ is all $1$, and thus it contains no information about a stock’s individual fluctuations (interpreted as risk). To combat this, we originally tried to use the covariance matrix $V$ of the time-series data instead, as in that case $V_{ii}$ the variance of an individual stock would be a factor. However, this yielded very poor results (for unclear reasons). Thus, we instead take the correlation matrix $C$ and modify its diagonal entries to obtain a suitable matrix $D$.</p>

<p>First, we find $\beta$ as follows:</p>

<ul>
  <li>
    <p>Hello</p>

    <ul>
      <li>Hello
How are you</li>
      <li>Hello</li>
      <li>Hello</li>
    </ul>
  </li>
</ul>

<script type="math/tex; mode=display">\beta = \max \left\{ \,\sum_{j = 1,\, j \neq i}^n{C_{ij}} \quad \text{ for all } i \in \{1,2,\ldots,n\} \right\}</script>

<p>We calculate this value because we’d like $D$ to be positive definite, which is the case if and only if each entry on the diagonal is greater than the sum of all other values in its row. Therefore, $\beta$ is a “safe” scalar in that, if each entry on the diagonal of $C$ is at least $1$ and we multiply each of those entries by $\beta$, the result will necessarily be positive definite.</p>

<p>Then, we can construct $D$. First, $D$ begins as a copy of $V$ the covariance matrix, except that each diagonal entry $D_{ii}$ is “normalized” (divided by the square of the mean of row $i$) and then “scaled” (divided by the minimum entry on the diagonal, so that the smallest diagonal entry is $1$ and all others are larger). Then, we copy into $D$ all of the non-main-diagonal entries from $C$ the correlation matrix, so that $D$ is <em>mostly</em> the correlation matrix but with the main diagonal of $V$. Finally, we multiply the diagonal entries of $D$ by $\beta$, to ensure that $D$ is positive definite.</p>

<h3 id="the-algorithm">The Algorithm</h3>

<p>Now, this part would be simple if $n$ were always small, as we could just iterate over all possible subsets of tickers to find the one whose state gave the highest score. However, when $n$ is large, the fact that there are $2^n$ such subsets makes this solution intractable, so we’re forced to do a probabilistic search. The search goes as follows:</p>

<p>For each integer $i$ from $1$ to $n$, we’ll randomly choose $i$ integers from $\{1,2,\ldots,n\}$ and “strike out” the rows and columns from $C$ corresponding to those integers to create $C’$ (as one would do in the process of cofactor expansion), and similarly the respective components of $b$ to create $b’$. Let the set of the indices of the remaining rows/columns in $C’$ be called $R$. We calculate the score of the state gotten from $C’$ and $b’$, and call that the “baseline”.</p>

<p>Then, we repeat the process to get a new $C’$ and $b’$ based on a different set $R$ of remaining vertices, and if the score of that state is higher than the baseline, then it <em>becomes</em> the new baseline. This process is repeated <code class="highlighter-rouge">Iterations</code> times, and because we keep track of each $C’$, $b’$ and $R$, we can create histograms of which rows/columns are the most common to appear in “victorious” states (ones that beat the previous baseline and became the new baseline).</p>

<blockquote>
  <p>Note: Because this is an annealing algorithm, we also sometimes accept states whose scores are <em>lower</em> than the baseline. The probability of this happening is given by whether $e^{ad} &gt; \mu$, where $a$ is <code class="highlighter-rouge">Anneal</code>, $d$ is the difference between the scores, and $\mu$ is uniformly random on $(0,1)$.</p>
</blockquote>

<p>Then to finish, once these histograms have been made (and the main loop of the algorithm is done), we find the best-guess optimum for each $i$ from $1$ to $n$, where this optimum is defined to be the tallest $i$ bars (the most common $i$ rows/columns in “victorious” states) in the specific histogram which corresponds to states where $|R| = i$. These best-guess optima are all sets of indices, each with a different size – the smallest one only has one element (presumably the index of the best stock) and the largest is $\{1,2,\ldots,n\}$. Then, for each such set $S$, we get the matrix $C’$ and vector $b’$ from $C$ and $b$ but with only indices from $S$ included, like before, and find the score of that state. The state that achieves the highest score in this process is the “best” subset of the $n$ stocks.</p>

<h3 id="comparisons">Comparisons</h3>

<p>At the end of the process, we have a “best” subset of rows to use according to the algorithm using matrix $C$. Then, we run the whole thing again, keeping all things the same except for using $D$ in place of $C$, and save that output’s “best” subset of rows as well. Then, at the bottom of the page’s rendered output, there’s a section labeled <strong>check the difference</strong>. Here, one can enter a time period for data collection, and directly compare how the subset from $C$ and the subset from $D$ would perform in terms of returns over time.</p>

<p>In addition, the area just above this (labeled <strong>compare portfolio performance</strong>) allows for similar performance comparisons between the subset from $C$ and a uniform portfolio, the S&amp;P 500, and a custom portfolio.</p>

<h2 id="areas-for-improvement">Areas for Improvement</h2>

<ul>
  <li>Make the website “responsive”, so the interface is still usable on a smartphone or tablet</li>
  <li>Very much of this process could be (and possibly needs to be) parallelized, though that would likely require a move away from Python as the implementation language</li>
  <li>Figure out how hard it would be to add ETF functionality to the program, instead of only stocks</li>
  <li>Similarly, we could add stocks from different countries</li>
  <li>More (or different) graphs, maybe with JS, make the data easier to visualize</li>
</ul>


				</div>
			</div>

		</section>

	</main>

	<footer class="footer">
		<div class="container">
			<div class="content has-text-centered">
				<hr>
				<div class="columns is-centered" style = "margin-right: 0">
					<div class="column is-half is-marginless is-paddingless">
						<br>
						<p class="is-marginless has-text-right">
							Made with <a href="https://bulma.io">Bulma</a> &nbsp; | &nbsp; Last updated 21 Jul 2018
						</p>
						<br>
					</div>
				</div>
			</div>
		</div>
	</footer>

	</body>

</html>